<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Ve√≠culos</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>
    <div class="dashboard active">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i data-lucide="chevron-left" class="toggle-icon"></i>
            </button>
            <h2>Sistema de Ve√≠culos</h2>
                <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                    <i data-lucide="bar-chart-3" class="nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </a></li>
                <li><a href="#uso-veiculos" class="nav-link" onclick="showSection('uso-veiculos')">
                    <i data-lucide="clipboard-list" class="nav-icon"></i>
                    <span class="nav-text">Uso de Ve√≠culos</span>
                </a></li>
                <li><a href="#despesas" class="nav-link" onclick="showSection('despesas')">
                    <i data-lucide="credit-card" class="nav-icon"></i>
                    <span class="nav-text">Despesas</span>
                </a></li>
                <li><a href="#manutencao" class="nav-link" onclick="showSection('manutencao')">
                    <i data-lucide="wrench" class="nav-icon"></i>
                    <span class="nav-text">Manuten√ß√£o</span>
                </a></li>
                <li><a href="#inspecoes" class="nav-link" onclick="showSection('inspecoes')">
                    <i data-lucide="clipboard-check" class="nav-icon"></i>
                    <span class="nav-text">Inspe√ß√µes</span>
                </a></li>
                <li><a href="#alertas" class="nav-link" onclick="showSection('alertas')">
                    <i data-lucide="alert-triangle" class="nav-icon"></i>
                    <span class="nav-text">Alertas</span>
                </a></li>
                <li><a href="#rastreamento" class="nav-link" onclick="showSection('rastreamento')">
                    <i data-lucide="navigation" class="nav-icon"></i>
                    <span class="nav-text">Rastreamento GPS</span>
                </a></li>
                <li><a href="#cadastros" class="nav-link" onclick="showSection('cadastros')">
                    <i data-lucide="folder" class="nav-icon"></i>
                    <span class="nav-text">Cadastros</span>
                </a></li>
            </ul>
            <div class="version-info">
                <span class="version-text">v0.2.0 Beta</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i data-lucide="log-out" class="logout-icon"></i>
                <span>Sair</span>
            </button>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1>Dashboard - Controle de Ve√≠culos</h1>
                <div class="user-welcome">
                    <p id="welcomeMessage">Bem-vindo</p>
                    <span id="userRoleBadge" class="user-role-badge role-admin">Admin</span>
                </div>
            </div>
            
            <!-- Se√ß√£o Dashboard -->
            <div id="dashboard" class="content-section active">
                <h2 class="section-title">Vis√£o Geral da Frota</h2>

                <!-- KPIs Principais -->
                <div class="kpi-cards">
                    <!-- KPI 1: Frota Total -->
                    <div class="stat-card kpi-primary">
                        <div class="stat-icon-text">FROTA TOTAL</div>
                        <div class="stat-number" id="kpiFleetTotal">0</div>
                        <div class="stat-label">Ve√≠culos Cadastrados</div>
                        <div class="stat-detail" id="kpiFleetBreakdown">
                            <span class="fleet-status-item">
                                <span class="status-dot status-available"></span>
                                <span id="kpiFleetAvailable">0</span> Dispon√≠veis
                            </span>
                            <span class="fleet-status-item">
                                <span class="status-dot status-in-use"></span>
                                <span id="kpiFleetInUse">0</span> Em uso
                            </span>
                            <span class="fleet-status-item">
                                <span class="status-dot status-maintenance"></span>
                                <span id="kpiFleetMaintenance">0</span> Manuten√ß√£o
                            </span>
                        </div>
                    </div>

                    <!-- KPI 2: Alertas Cr√≠ticos -->
                    <div class="stat-card kpi-alert">
                        <div class="stat-icon-text">ALERTAS</div>
                        <div class="stat-number" id="kpiTotalAlerts">0</div>
                        <div class="stat-label">Pend√™ncias Cr√≠ticas</div>
                        <div class="stat-detail" id="kpiAlertsDetail">
                            <span style="color: #f59e0b;">
                                <span id="kpiMaintenanceCount">0</span> Manuten√ß√µes
                            </span>
                            <span style="color: #ef4444; margin-left: 12px;">
                                <span id="kpiCNHCount">0</span> CNHs
                            </span>
                        </div>
                    </div>

                    <!-- KPI 3: Custo Total -->
                    <div class="stat-card kpi-cost">
                        <div class="stat-icon-text">CUSTO TOTAL</div>
                        <div class="stat-number" id="kpiTotalCost">R$ 0</div>
                        <div class="stat-label">Manuten√ß√µes Realizadas</div>
                        <div class="stat-detail" id="kpiCostDetail">√öltimos 6 meses</div>
                    </div>

                    <!-- KPI 4: Motoristas -->
                    <div class="stat-card kpi-driver">
                        <div class="stat-icon-text">MOTORISTAS</div>
                        <div class="stat-number" id="kpiDashboardTotalDrivers">0</div>
                        <div class="stat-label">Total Cadastrados</div>
                        <div class="stat-detail" id="kpiDashboardDriversBreakdown">
                            <span class="fleet-status-item">
                                <span class="status-dot status-available"></span>
                                <span id="kpiDashboardActiveDrivers">0</span> Ativos
                            </span>
                            <span class="fleet-status-item">
                                <span class="status-dot status-maintenance"></span>
                                <span id="kpiDashboardInactiveDrivers">0</span> Inativos
                            </span>
                        </div>
                    </div>

                    <!-- KPI 5: Inspe√ß√µes Semanais -->
                    <div class="stat-card kpi-inspection" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                        <div class="stat-icon-text">INSPE√á√ïES</div>
                        <div class="stat-number" id="kpiInspectionCompliance">0%</div>
                        <div class="stat-label">Conformidade Semanal</div>
                        <div class="stat-detail" id="kpiInspectionDetail">
                            <span style="color: #10b981;" id="kpiInspectionOk">0 Em dia</span>
                            <span style="color: #f59e0b; margin-left: 8px;" id="kpiInspectionDueSoon">0 Vence breve</span>
                            <span style="color: #ef4444; margin-left: 8px;" id="kpiInspectionOverdue">0 Vencidas</span>
                        </div>
                    </div>
                </div>

                <!-- Linha 2: Status da Frota + Mapa GPS em Tempo Real -->
                <div class="dashboard-row-2">
                    <!-- Status da Frota -->
                    <div class="stat-card ranking-card">
                        <div class="stat-icon-text">STATUS DA FROTA</div>
                        <div style="height: 320px; margin-top: 12px;">
                            <canvas id="fleetStatusChart"></canvas>
                        </div>
                    </div>

                    <!-- Mapa GPS em Tempo Real -->
                    <div class="stat-card ranking-card">
                        <div class="stat-icon-text">RASTREAMENTO EM TEMPO REAL</div>
                        <div id="dashboardGpsMap" style="height: 320px; margin-top: 12px; border-radius: 8px; overflow: hidden;"></div>
                    </div>
                </div>

                <!-- Linha 3: Rankings Top 5 -->
                <div class="rankings-grid">
                    <!-- Ranking: Top 5 Ve√≠culos -->
                    <div class="stat-card ranking-card">
                        <div class="stat-icon-text">TOP 5 VE√çCULOS MAIS UTILIZADOS</div>
                        <div class="ranking-list" id="rankingVehicles">
                            <div class="ranking-empty">Carregando...</div>
                        </div>
                    </div>

                    <!-- Ranking: Top 5 Motoristas -->
                    <div class="stat-card ranking-card">
                        <div class="stat-icon-text">TOP 5 MOTORISTAS MAIS ATIVOS</div>
                        <div class="ranking-list" id="rankingDrivers">
                            <div class="ranking-empty">Carregando...</div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="charts-grid">
                    <!-- Linha 1: 2 Colunas - Gr√°ficos de Manuten√ß√£o -->
                    <div class="chart-container">
                        <h3 class="chart-title">Custos Mensais de Manuten√ß√£o</h3>
                        <canvas id="maintenanceCostsChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Manuten√ß√µes por Tipo</h3>
                        <canvas id="maintenanceTypesChart"></canvas>
                    </div>

                    <!-- Linha 2: 1 Coluna Full Width -->
                    <div class="chart-container chart-full">
                        <h3 class="chart-title">CNHs - Vencimentos Pr√≥ximos</h3>
                        <canvas id="cnhTimelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Inspe√ß√µes -->
            <div id="inspecoes" class="content-section">
                <h2 class="section-title">üîç Inspe√ß√µes de Ve√≠culos</h2>

                <!-- KPIs de Inspe√ß√µes -->
                <div class="kpi-cards">
                    <div class="stat-card kpi-success">
                        <div class="stat-icon-text">APROVADAS</div>
                        <div class="stat-number" id="kpiInspecoesAprovadas">0</div>
                        <div class="stat-label">Inspe√ß√µes aprovadas este m√™s</div>
                    </div>
                    <div class="stat-card kpi-warning">
                        <div class="stat-icon-text">COM RESTRI√á√ÉO</div>
                        <div class="stat-number" id="kpiInspecoesRestricao">0</div>
                        <div class="stat-label">Aprovadas com restri√ß√£o</div>
                    </div>
                    <div class="stat-card kpi-danger">
                        <div class="stat-icon-text">REPROVADAS</div>
                        <div class="stat-number" id="kpiInspecoesReprovadas">0</div>
                        <div class="stat-label">Inspe√ß√µes reprovadas</div>
                    </div>
                    <div class="stat-card kpi-info">
                        <div class="stat-icon-text">PENDENTES</div>
                        <div class="stat-number" id="kpiInspecoesPendentes">0</div>
                        <div class="stat-label">Inspe√ß√µes aguardando realiza√ß√£o</div>
                    </div>
                </div>

                <!-- Sistema de Tabs -->
                <div class="inspecoes-tabs">
                    <button class="inspecao-tab-btn active" onclick="showInspecaoTab('pre-viagem')">
                        <i data-lucide="clipboard-check"></i> Pr√©-Viagem
                    </button>
                    <button class="inspecao-tab-btn" onclick="showInspecaoTab('revisao')">
                        <i data-lucide="wrench"></i> Revis√£o T√©cnica
                    </button>
                    <button class="inspecao-tab-btn" onclick="showInspecaoTab('historico')">
                        <i data-lucide="history"></i> Hist√≥rico
                    </button>
                </div>

                <!-- Conte√∫do das Tabs -->
                <div class="inspecoes-content">

                    <!-- Tab: Pr√©-Viagem -->
                    <div id="pre-viagem" class="inspecao-tab-panel active">
                        <div class="section-header">
                            <h3>Inspe√ß√£o Pr√©-Viagem</h3>
                            <button class="btn btn-success" onclick="novaInspecao('pre_viagem')">
                                <i data-lucide="plus"></i> Nova Inspe√ß√£o
                            </button>
                        </div>

                        <div class="filters-row">
                            <select id="filterPreViagemVeiculo" class="form-control" onchange="filterInspecoesPreViagem()">
                                <option value="">Todos os ve√≠culos</option>
                            </select>
                            <select id="filterPreViagemStatus" class="form-control" onchange="filterInspecoesPreViagem()">
                                <option value="">Todos os status</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="aprovado_com_restricao">Aprovado com Restri√ß√£o</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                            <input type="date" id="filterPreViagemData" class="form-control" onchange="filterInspecoesPreViagem()">
                        </div>

                        <div class="table-container">
                            <table id="preViagemTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Ve√≠culo</th>
                                        <th>Motorista</th>
                                        <th>KM</th>
                                        <th>Status</th>
                                        <th>N√£o Conformidades</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="preViagemTableBody">
                                    <tr>
                                        <td colspan="7" class="empty-state">Nenhuma inspe√ß√£o pr√©-viagem realizada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab: Revis√£o T√©cnica -->
                    <div id="revisao" class="inspecao-tab-panel">
                        <div class="section-header">
                            <h3>Revis√£o T√©cnica</h3>
                            <button class="btn btn-success" onclick="novaInspecao('revisao')">
                                <i data-lucide="plus"></i> Nova Revis√£o
                            </button>
                        </div>

                        <div class="filters-row">
                            <select id="filterRevisaoVeiculo" class="form-control" onchange="filterInspecoesRevisao()">
                                <option value="">Todos os ve√≠culos</option>
                            </select>
                            <select id="filterRevisaoStatus" class="form-control" onchange="filterInspecoesRevisao()">
                                <option value="">Todos os status</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="aprovado_com_restricao">Aprovado com Restri√ß√£o</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                            <input type="date" id="filterRevisaoData" class="form-control" onchange="filterInspecoesRevisao()">
                        </div>

                        <div class="table-container">
                            <table id="revisaoTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Ve√≠culo</th>
                                        <th>Motorista/Mec√¢nico</th>
                                        <th>KM</th>
                                        <th>Status</th>
                                        <th>Pr√≥xima Revis√£o</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="revisaoTableBody">
                                    <tr>
                                        <td colspan="7" class="empty-state">Nenhuma revis√£o t√©cnica realizada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab: Hist√≥rico -->
                    <div id="historico" class="inspecao-tab-panel">
                        <h3>Hist√≥rico de Inspe√ß√µes</h3>

                        <div class="filters-row">
                            <select id="filterHistoricoVeiculo" class="form-control" onchange="filterHistoricoInspecoes()">
                                <option value="">Todos os ve√≠culos</option>
                            </select>
                            <select id="filterHistoricoTipo" class="form-control" onchange="filterHistoricoInspecoes()">
                                <option value="">Todos os tipos</option>
                                <option value="pre_viagem">Pr√©-Viagem</option>
                                <option value="revisao">Revis√£o T√©cnica</option>
                            </select>
                            <input type="date" id="filterHistoricoDataInicio" class="form-control" placeholder="Data In√≠cio" onchange="filterHistoricoInspecoes()">
                            <input type="date" id="filterHistoricoDataFim" class="form-control" placeholder="Data Fim" onchange="filterHistoricoInspecoes()">
                        </div>

                        <div class="table-container">
                            <table id="historicoInspecoesTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Ve√≠culo</th>
                                        <th>Respons√°vel</th>
                                        <th>Status</th>
                                        <th>Itens Verificados</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="historicoInspecoesTableBody">
                                    <tr>
                                        <td colspan="7" class="empty-state">Nenhuma inspe√ß√£o no hist√≥rico</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Se√ß√£o Cadastros -->
            <div id="cadastros" class="content-section">
                <h2 class="section-title">üìã Cadastros</h2>

                <!-- Sistema de Tabs -->
                <div class="cadastros-tabs">
                    <button class="cadastro-tab-btn active" onclick="showCadastroTab('veiculos')">
                        <i data-lucide="car"></i> Ve√≠culos
                    </button>
                    <button class="cadastro-tab-btn" onclick="showCadastroTab('motoristas')">
                        <i data-lucide="users"></i> Motoristas
                    </button>
                    <button class="cadastro-tab-btn" onclick="showCadastroTab('destinos')">
                        <i data-lucide="map-pin"></i> Destinos
                    </button>
                </div>

                <!-- Conte√∫do das Tabs -->
                <div class="cadastros-content">

            <!-- Tab: Se√ß√£o Ve√≠culos -->
            <div id="veiculos" class="cadastro-tab-panel active">
                <h2 class="section-title">Gest√£o de Ve√≠culos</h2>
                <button class="btn btn-success" onclick="resetVehicleForm(); openModal('vehicleModal')">Novo Ve√≠culo</button>
                <div class="table-container">
                    <table id="vehiclesTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Placa</th>
                                <th>Marca/Modelo</th>
                                <th>Ano</th>
                                <th>Status</th>
                                <th>KM Atual</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Se√ß√£o Motoristas -->
            <div id="motoristas" class="cadastro-tab-panel">
                <h2 class="section-title">Gest√£o de Motoristas</h2>
                <button class="btn btn-success" onclick="resetDriverForm(); openModal('driverModal')">Novo Motorista</button>
                <div class="table-container">
                    <table id="driversTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Motorista</th>
                                <th>CNH</th>
                                <th>Validade</th>
                                <th>Status CNH</th>
                                <th>KM Total</th>
                                <th>Telefone</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Se√ß√£o Destinos -->
            <div id="destinos" class="cadastro-tab-panel">
                <h2 class="section-title">Cadastro de Destinos</h2>
                <button class="btn btn-success" onclick="resetDestinationForm(); openModal('destinationModal')">Novo Destino</button>
                <div class="table-container">
                    <table id="destinationsTable">
                        <thead>
                            <tr>
                                <th>Nome do Destino</th>
                                <th>Dist√¢ncia (KM)</th>
                                <th>Data de Cadastro</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="destinationsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

                </div><!-- Fim: cadastros-content -->
            </div><!-- Fim: Se√ß√£o Cadastros -->

            <!-- Se√ß√£o Uso de Ve√≠culos -->
            <div id="uso-veiculos" class="content-section">
                <h2 class="section-title">Controle de Uso de Ve√≠culos</h2>

                <!-- KPIs de Uso de Ve√≠culos -->
                <div class="kpi-cards">
                    <div class="stat-card kpi-usage-total">
                        <div class="stat-icon-text">TOTAL VIAGENS</div>
                        <div class="stat-number" id="kpiTotalTrips">0</div>
                        <div class="stat-label">Registros cadastrados</div>
                        <div class="stat-detail" id="kpiTripsBreakdown">
                            <span class="fleet-status-item">
                                <span class="status-dot status-in-use"></span>
                                <span id="kpiActiveTrips">0</span> Ativas
                            </span>
                            <span class="fleet-status-item">
                                <span class="status-dot status-available"></span>
                                <span id="kpiCompletedTrips">0</span> Finalizadas
                            </span>
                        </div>
                    </div>

                    <div class="stat-card kpi-distance">
                        <div class="stat-icon-text">DIST√ÇNCIA TOTAL</div>
                        <div class="stat-number" id="kpiTotalDistance">0 km</div>
                        <div class="stat-label">Quil√¥metros percorridos</div>
                        <div class="stat-detail" id="kpiDistanceDetail">√öltimos 30 dias</div>
                    </div>

                    <div class="stat-card kpi-popular-destination">
                        <div class="stat-icon-text">DESTINO POPULAR</div>
                        <div class="stat-number" id="kpiPopularDestination">-</div>
                        <div class="stat-label">Mais visitado</div>
                        <div class="stat-detail" id="kpiPopularDestinationCount">0 viagens</div>
                    </div>

                    <div class="stat-card kpi-active-vehicle">
                        <div class="stat-icon-text">VE√çCULO ATIVO</div>
                        <div class="stat-number" id="kpiMostUsedVehicle">-</div>
                        <div class="stat-label">Mais utilizado</div>
                        <div class="stat-detail" id="kpiMostUsedVehicleCount">0 viagens</div>
                    </div>
                </div>

                <!-- Bot√£o Nova Viagem -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="resetUsageForm(); openModal('usageModal')">
                        + Nova Viagem
                    </button>
                </div>

                <!-- Filtros Redesenhados -->
                <div class="filters-container">
                    <div class="advanced-filters">
                        <div class="filter-group">
                            <label for="filterVehicle">VE√çCULO</label>
                            <select id="filterVehicle" class="filter-select">
                                <option value="">Todos</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="filterDriver">MOTORISTA</label>
                            <select id="filterDriver" class="filter-select">
                                <option value="">Todos</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="filterDestination">DESTINO</label>
                            <select id="filterDestination" class="filter-select">
                                <option value="">Todos</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="filterDateStart">DATA INICIAL</label>
                            <input type="date" id="filterDateStart" class="filter-select">
                        </div>

                        <div class="filter-group">
                            <label for="filterDateEnd">DATA FINAL</label>
                            <input type="date" id="filterDateEnd" class="filter-select">
                        </div>

                        <div class="filter-group">
                            <label for="filterStatus">STATUS</label>
                            <select id="filterStatus" class="filter-select">
                                <option value="">Todos</option>
                                <option value="em-uso">Em uso</option>
                                <option value="finalizada">Finalizadas</option>
                            </select>
                        </div>

                        <!-- Bot√µes integrados na mesma linha -->
                        <div class="filters-actions-inline">
                            <button class="btn btn-primary" onclick="applyUsageFilters()">
                                Aplicar
                            </button>
                            <button class="btn btn-secondary" onclick="clearUsageFilters()">
                                Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Resumo de Filtros Ativos -->
                    <div id="activeFiltersDisplay" class="active-filters-display" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span class="active-filters-label">Filtros ativos:</span>
                            <div id="filterBadges" class="filter-badges-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Uso -->
                <div class="table-container">
                    <table id="usageTable">
                        <thead>
                            <tr>
                                <th>Ve√≠culo</th>
                                <th>Placa</th>
                                <th>Motorista</th>
                                <th>Destino</th>
                                <th class="sortable" onclick="sortUsageTable('departure')">Sa√≠da <span class="sort-icon">‚áÖ</span></th>
                                <th class="sortable" onclick="sortUsageTable('return')">Retorno <span class="sort-icon">‚áÖ</span></th>
                                <th style="text-align: center;">Dura√ß√£o</th>
                                <th style="text-align: center;">KM Percorridos</th>
                                <th style="text-align: center;">Custo (R$)</th>
                                <th style="text-align: center;">Intercorr√™ncia</th>
                                <th style="text-align: center;">Aprova√ß√£o</th>
                                <th style="text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="usageTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Mensagem vazia -->
                <div id="usageEmptyState" class="usage-empty-state" style="display: none;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üöó</div>
                    <h3>Nenhuma viagem encontrada</h3>
                    <p>N√£o h√° registros que correspondam aos filtros selecionados</p>
                    <button class="btn btn-primary" onclick="clearUsageFilters()">Limpar Filtros</button>
                </div>
            </div>

            <!-- Se√ß√£o Despesas -->
            <div id="despesas" class="content-section">
                <h2 class="section-title">Despesas / Abastecimento</h2>

                <!-- KPI Cards para Despesas -->
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total do M√™s</h3>
                        <p class="stat-value" id="expenseMonthTotal">R$ 0,00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Abastecimento</h3>
                        <p class="stat-value" id="expenseFuelTotal">R$ 0,00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Manuten√ß√£o</h3>
                        <p class="stat-value" id="expenseMaintenanceTotal">R$ 0,00</p>
                    </div>
                    <div class="stat-card">
                        <h3>M√©dia Consumo</h3>
                        <p class="stat-value" id="expenseAvgConsumption">-- L/100km</p>
                    </div>
                </div>

                <!-- Filtros de Despesas -->
                <div class="filters-container" style="margin-top: 20px; margin-bottom: 20px;">
                    <div class="filter-group">
                        <label for="expenseFilterPeriod">Per√≠odo:</label>
                        <select id="expenseFilterPeriod" class="filter-select" onchange="filterExpenses()">
                            <option value="">Todos</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month" selected>Este M√™s</option>
                            <option value="last30">√öltimos 30 dias</option>
                            <option value="last90">√öltimos 90 dias</option>
                            <option value="year">Este Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>

                    <div class="filter-group" id="customDateRange" style="display:none;">
                        <label for="expenseFilterStartDate">De:</label>
                        <input type="date" id="expenseFilterStartDate" class="filter-input" onchange="filterExpenses()">
                        <label for="expenseFilterEndDate">At√©:</label>
                        <input type="date" id="expenseFilterEndDate" class="filter-input" onchange="filterExpenses()">
                    </div>

                    <div class="filter-group">
                        <label for="expenseFilterVehicle">Ve√≠culo:</label>
                        <select id="expenseFilterVehicle" class="filter-select" onchange="filterExpenses()">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="expenseFilterDriver">Motorista:</label>
                        <select id="expenseFilterDriver" class="filter-select" onchange="filterExpenses()">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="expenseFilterCategory">Categoria:</label>
                        <select id="expenseFilterCategory" class="filter-select" onchange="filterExpenses()">
                            <option value="">Todas</option>
                            <option value="abastecimento">Abastecimento</option>
                            <option value="manutencao">Manuten√ß√£o</option>
                            <option value="ipva">IPVA</option>
                            <option value="multa">Multa</option>
                            <option value="seguro">Seguro</option>
                            <option value="licenciamento">Licenciamento</option>
                            <option value="pneus">Pneus</option>
                            <option value="lavagem">Lavagem</option>
                            <option value="documentacao">Documenta√ß√£o</option>
                            <option value="pedagio">Ped√°gio</option>
                            <option value="estacionamento">Estacionamento</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="filterExpenses()">Aplicar Filtros</button>
                        <button class="btn btn-secondary" onclick="clearExpenseFilters()">Limpar</button>
                    </div>
                </div>

                <div style="margin-bottom: 12px; display:flex; gap:10px;">
                    <button class="btn btn-success" onclick="openModal('expenseModal'); resetExpenseForm()">Nova Despesa</button>
                    <button class="btn btn-secondary" onclick="loadExpensesTable()">Atualizar</button>
                    <button class="btn btn-info" onclick="exportExpenses()">Exportar</button>
                </div>
                <div class="table-container">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Ve√≠culo</th>
                                <th>Categoria</th>
                                <th>KM</th>
                                <th>Litros</th>
                                <th>Pre√ßo/L</th>
                                <th>Total</th>
                                <th>Observa√ß√µes</th>
                                <th style="text-align:center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Despesa -->
            <div id="expenseModal" class="modal">
                <div class="modal-content" style="max-width: 720px;">
                    <span class="close" onclick="closeModal('expenseModal')">&times;</span>
                    <h3>Nova Despesa</h3>
                    <form id="expenseForm" onsubmit="event.preventDefault(); addExpense()">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseVehicle">Ve√≠culo</label>
                                <select id="expenseVehicle" required></select>
                            </div>
                            <div class="form-group">
                                <label for="expenseCategory">Categoria</label>
                                <select id="expenseCategory" required onchange="toggleExpenseFields()">
                                    <option value="abastecimento">Abastecimento</option>
                                    <option value="manutencao">Manuten√ß√£o</option>
                                    <option value="ipva">IPVA</option>
                                    <option value="multa">Multa</option>
                                    <option value="seguro">Seguro</option>
                                    <option value="licenciamento">Licenciamento</option>
                                    <option value="pneus">Pneus</option>
                                    <option value="lavagem">Lavagem</option>
                                    <option value="documentacao">Documenta√ß√£o</option>
                                    <option value="pedagio">Ped√°gio</option>
                                    <option value="estacionamento">Estacionamento</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseDate">Data e Hora</label>
                                <input type="datetime-local" id="expenseDate" required>
                            </div>
                            <div class="form-group">
                                <label for="expenseKm">KM Atual</label>
                                <input type="number" id="expenseKm" min="0" placeholder="Opcional">
                            </div>
                        </div>
                        <div id="fuelFields" class="form-row">
                            <div class="form-group">
                                <label for="expenseLiters">Quantidade (litros)</label>
                                <input type="number" id="expenseLiters" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="expensePricePerLiter">Pre√ßo por Litro (R$)</label>
                                <input type="text" id="expensePricePerLiter" placeholder="R$ 0,00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:1;">
                                <label for="expenseTotal">Valor Total (R$)</label>
                                <input type="text" id="expenseTotal" placeholder="R$ 0,00 (auto)" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expenseNotes">Observa√ß√µes</label>
                            <textarea id="expenseNotes" rows="3" placeholder="Opcional"></textarea>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" class="btn btn-success">Salvar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('expenseModal')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Intercorr√™ncia -->
            <div id="incidentModal" class="modal">
                <div class="modal-content" style="max-width: 720px;">
                    <span class="close" onclick="closeModal('incidentModal')">&times;</span>
                    <h3>Intercorr√™ncia da Viagem</h3>
                    <div id="incidentDetails" style="margin-top: 12px; display: grid; gap: 12px;">
                        <div>
                            <strong style="color: #fff;">Observa√ß√µes:</strong>
                            <div id="incidentNotes" style="margin-top: 6px; white-space: pre-wrap; color: #fff;">-</div>
                        </div>
                        <div id="incidentPhotoBlock" style="display:none;">
                            <strong>Foto:</strong>
                            <div id="incidentPhotoWrapper" style="margin-top: 6px; width: 100%; max-height: 420px; overflow: hidden; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <img id="incidentPhoto" alt="Foto da intercorr√™ncia" style="width: 100%; height: auto; display: block;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Manuten√ß√£o -->
            <div id="manutencao" class="content-section">
                <h2 class="section-title">Controle de Manuten√ß√£o</h2>
                <button class="btn btn-success" onclick="resetMaintenanceForm(); openModal('maintenanceModal')">Novo Registro</button>
                <div class="table-container">
                    <table id="maintenanceTable">
                        <thead>
                            <tr>
                                <th>Ve√≠culo</th>
                                <th>Tipo</th>
                                <th>Data</th>
                                <th>KM</th>
                                <th>Valor</th>
                                <th>Descri√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="maintenanceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Se√ß√£o Alertas -->
            <div id="alertas" class="content-section">
                <h2 class="section-title">Alertas e Notifica√ß√µes</h2>
                <div id="alertsContainer">
                    <!-- Alertas ser√£o carregados aqui -->
                </div>
            </div>

            <!-- Se√ß√£o Rastreamento GPS -->
            <div id="rastreamento" class="content-section">
                <h2 class="section-title">Rastreamento GPS</h2>

                <!-- Tab Navigation -->
                <div class="gps-tabs" style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.18);">
                    <button class="btn btn-primary gps-tab-btn active" data-tab="realtime">
                        Tempo Real
                    </button>
                    <button class="btn btn-secondary gps-tab-btn" data-tab="history">
                        Hist√≥rico
                    </button>
                </div>

                <!-- Tab 1: Real-Time Tracking -->
                <div id="tab-realtime" class="gps-tab-panel active">
                    <!-- Mapa -->
                    <div class="map-container">
                        <div id="gpsMap" style="height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);"></div>
                    </div>

                    <!-- Informa√ß√µes dos ve√≠culos ativos -->
                    <div class="active-vehicles-info" style="margin-top: 20px;">
                        <h3 class="section-subtitle">Ve√≠culos Ativos</h3>
                        <div id="activeVehiclesList" class="vehicles-grid">
                            <!-- Ve√≠culos ativos ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Route History -->
                <div id="tab-history" class="gps-tab-panel" style="display: none;">
                    <div class="route-history-layout" style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 700px;">

                        <!-- Sidebar esquerda com lista de rotas -->
                        <div class="route-sidebar card" style="overflow-y: auto; padding: 20px;">
                            <h3 class="section-subtitle" style="margin-bottom: 15px;">Viagens Finalizadas</h3>
                            <div id="routeSidebar">
                                <!-- Route cards ser√£o carregados aqui via JS -->
                            </div>
                        </div>

                        <!-- Mapa direita -->
                        <div class="route-map-container" style="position: relative;">
                            <div id="routeHistoryMap" style="height: 100%; border-radius: 12px; overflow: hidden;"></div>

                            <!-- Floating info card sobre o mapa - formato c√°psula centralizado -->
                            <div id="routeInfoOverlay" class="route-info-capsule" style="display: none;">
                                <!-- Info da rota ser√° carregada aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modais -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('vehicleModal')">&times;</span>
            <h3 id="vehicleModalTitle">Novo Ve√≠culo</h3>
            <form id="vehicleForm">
                <input type="hidden" id="vehicleId">

                <!-- Foto do Ve√≠culo -->
                <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                    <label>Foto do Ve√≠culo:</label>
                    <div id="vehiclePhotoPreview" style="width: 200px; height: 150px; margin: 10px auto; border: 2px dashed #ccc; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
                        <span style="color: #999;">Sem foto</span>
                    </div>
                    <input type="file" id="vehiclePhoto" accept="image/*" onchange="previewVehiclePhoto(event)" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('vehiclePhoto').click()">üì∑ Selecionar Foto</button>
                    <button type="button" class="btn btn-danger" onclick="removeVehiclePhoto()" id="removeVehiclePhotoBtn" style="display: none;">üóëÔ∏è Remover</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Placa:</label>
                        <input type="text" id="vehiclePlate" required>
                    </div>
                    <div class="form-group">
                        <label>Marca:</label>
                        <input type="text" id="vehicleBrand" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Modelo:</label>
                        <input type="text" id="vehicleModel" required>
                    </div>
                    <div class="form-group">
                        <label>Ano:</label>
                        <input type="number" id="vehicleYear" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>KM Inicial:</label>
                        <input type="number" id="vehicleInitialKm" required min="0">
                    </div>
                    <div class="form-group">
                        <label>KM Atual:</label>
                        <input type="number" id="vehicleKm" required min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="vehicleStatus" required>
                            <option value="disponivel">Dispon√≠vel</option>
                            <option value="em-uso">Em Uso</option>
                            <option value="manutencao">Em Manuten√ß√£o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Revis√£o por KM:</label>
                        <select id="vehicleMaintenanceKm" required>
                            <option value="5000">5.000 km</option>
                            <option value="10000" selected>10.000 km</option>
                            <option value="12000">12.000 km</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Revis√£o por Tempo:</label>
                        <select id="vehicleMaintenanceTime" required>
                            <option value="3">3 meses</option>
                            <option value="6" selected>6 meses</option>
                            <option value="9">9 meses</option>
                            <option value="12">12 meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>√öltima Revis√£o (Data):</label>
                        <input type="date" id="vehicleLastMaintenanceDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>KM da √öltima Revis√£o:</label>
                        <input type="number" id="vehicleLastMaintenanceKm" min="0">
                    </div>
                    <div class="form-group"></div>
                </div>
                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>
    
    <div id="driverModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('driverModal')">&times;</span>
            <h3 id="driverModalTitle">Novo Motorista</h3>
            <form id="driverForm">
                <input type="hidden" id="driverId">

                <!-- Foto do Motorista -->
                <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                    <label>Foto do Motorista:</label>
                    <div id="driverPhotoPreview" style="width: 120px; height: 120px; margin: 10px auto; border: 2px dashed #ccc; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
                        <span style="color: #999;">Sem foto</span>
                    </div>
                    <input type="file" id="driverPhoto" accept="image/*" onchange="previewDriverPhoto(event)" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('driverPhoto').click()">üì∑ Selecionar Foto</button>
                    <button type="button" class="btn btn-danger" onclick="removeDriverPhoto()" id="removeDriverPhotoBtn" style="display: none;">üóëÔ∏è Remover</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo:</label>
                        <input type="text" id="driverName" required>
                    </div>
                    <div class="form-group">
                        <label>CNH:</label>
                        <input type="text" id="driverCnh" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Validade CNH:</label>
                        <input type="date" id="driverCnhExpiry" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone:</label>
                        <input type="tel" id="driverPhone" required>
                    </div>
                </div>

                <!-- Dados de Acesso ao Sistema -->
                <div style="border-top: 2px solid #e0e0e0; margin: 20px 0; padding-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">üîê Dados de Acesso ao Sistema</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="driverEmail" required placeholder="exemplo@email.com">
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" id="driverPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirmar Senha:</label>
                        <input type="password" id="driverPasswordConfirm" required minlength="6" placeholder="Digite a senha novamente">
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ‚ÑπÔ∏è Essas credenciais ser√£o usadas pelo motorista para acessar o sistema
                    </small>
                </div>

                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>
    
    <div id="usageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('usageModal')">&times;</span>
            <h3>Novo Registro de Uso</h3>
            <form id="usageForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ve√≠culo:</label>
                        <select id="usageVehicle" required onchange="updateKmMin()">
                            <option value="">Selecione o ve√≠culo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Motorista:</label>
                        <select id="usageDriver" required>
                            <option value="">Selecione o motorista</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data/Hora Sa√≠da:</label>
                        <input type="datetime-local" id="usageDeparture" required>
                    </div>
                    <div class="form-group">
                        <label>KM Sa√≠da:</label>
                        <input type="number" id="usageKmDeparture" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Destino:</label>
                    <select id="usageDestination" required>
                        <option value="">Selecione o destino</option>
                    </select>
                    <small style="display: block; margin-top: 5px; color: #666;">
                        üí° N√£o encontrou o destino? <a href="#destinos" onclick="showSection('destinos'); closeModal('usageModal');" style="color: #667eea;">Cadastre aqui</a>
                    </small>
                </div>

                <!-- Toggle de Intercorr√™ncia -->
                <div class="form-group incident-toggle-group">
                    <label class="incident-toggle-label">
                        <input type="checkbox" id="usageHasIncident" onchange="toggleIncidentFields()" class="incident-checkbox">
                        <span class="incident-toggle-text">
                            <span class="incident-icon">‚ö†Ô∏è</span>
                            Registrar Intercorr√™ncia
                        </span>
                    </label>
                </div>

                <!-- Campos condicionais de intercorr√™ncia -->
                <div id="incidentFields" class="incident-fields-container" style="display: none;">
                    <div class="form-group">
                        <label>Observa√ß√µes da Intercorr√™ncia:</label>
                        <textarea id="usageIncidentNotes" rows="4" placeholder="Descreva o que aconteceu durante a viagem..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Anexar Imagem da Intercorr√™ncia:</label>
                        <input type="file" id="usageIncidentPhoto" accept="image/*">
                        <small class="file-help-text">
                            üì∑ Formatos aceitos: JPG, PNG, GIF (m√°ximo 5MB)
                        </small>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>
    
    <div id="maintenanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('maintenanceModal')">&times;</span>
            <h3 id="maintenanceModalTitle">Nova Manuten√ß√£o</h3>
            <form id="maintenanceForm">
                <input type="hidden" id="maintenanceId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ve√≠culo:</label>
                        <select id="maintenanceVehicle" required>
                            <option value="">Selecione o ve√≠culo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="maintenanceType" required>
                            <option value="revis√£o">Revis√£o</option>
                            <option value="troca-oleo">Troca de √ìleo</option>
                            <option value="pneus">Troca de Pneus</option>
                            <option value="freios">Freios</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data:</label>
                        <input type="date" id="maintenanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>KM:</label>
                        <input type="number" id="maintenanceKm" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Valor:</label>
                    <input type="number" step="0.01" id="maintenanceValue" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="maintenanceDescription" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <div id="destinationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('destinationModal')">&times;</span>
            <h3 id="destinationModalTitle">Novo Destino</h3>
            <form id="destinationForm">
                <input type="hidden" id="destinationId">
                <div class="form-group">
                    <label>Nome do Destino:</label>
                    <input type="text" id="destinationName" required placeholder="Ex: Centro - Matriz, Aeroporto, Filial Norte">
                </div>

                <div class="form-group">
                    <label>Endere√ßo:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="destinationAddress"
                               placeholder="Ex: Av. Paulista, 1000 - S√£o Paulo/SP"
                               style="flex: 1;">
                        <button type="button" class="btn btn-primary"
                                onclick="geocodeDestinationAddress()"
                                style="white-space: nowrap;">
                            üìç Buscar GPS
                        </button>
                    </div>
                    <small class="help-text">Digite o endere√ßo e clique em "Buscar GPS" para obter coordenadas automaticamente</small>
                </div>

                <div class="form-group">
                    <label>Localiza√ß√£o no Mapa:</label>
                    <div id="destinationMapContainer" style="margin-bottom: 10px;">
                        <div id="destinationMap" style="height: 300px; border-radius: 8px; border: 1px solid #ddd;"></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666;">Latitude:</label>
                            <input type="number" id="destinationLatitude" step="any"
                                   placeholder="-23.550520" readonly
                                   style="background: #f5f5f5; color: #333;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666;">Longitude:</label>
                            <input type="number" id="destinationLongitude" step="any"
                                   placeholder="-46.633308" readonly
                                   style="background: #f5f5f5; color: #333;">
                        </div>
                    </div>
                    <small class="help-text">
                        üñ±Ô∏è Clique no mapa para ajustar a localiza√ß√£o manualmente<br>
                        üìç Ou use "Buscar GPS" para localizar automaticamente pelo endere√ßo
                    </small>
                </div>

                <div class="form-group">
                    <label>Dist√¢ncia (KM):</label>
                    <input type="number" id="destinationDistance" min="0" step="0.1" placeholder="Dist√¢ncia em quil√¥metros (opcional)">
                    <small class="help-text">Pode ser calculada automaticamente baseado na rota</small>
                </div>

                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal de Inspe√ß√£o -->
    <div id="inspecaoModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal('inspecaoModal')">&times;</span>
            <h3 id="inspecaoModalTitle">Nova Inspe√ß√£o</h3>
            <form id="inspecaoForm">
                <input type="hidden" id="inspecaoId">
                <input type="hidden" id="inspecaoTemplateId">

                <!-- Informa√ß√µes B√°sicas -->
                <div class="inspecao-header">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Inspe√ß√£o:</label>
                            <select id="inspecaoTipo" required onchange="carregarTemplateInspecao()">
                                <option value="">Selecione o tipo</option>
                                <option value="pre_viagem">Pr√©-Viagem</option>
                                <option value="revisao">Revis√£o T√©cnica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ve√≠culo:</label>
                            <select id="inspecaoVeiculo" required onchange="carregarKmAtual()">
                                <option value="">Selecione o ve√≠culo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Respons√°vel:</label>
                            <select id="inspecaoMotorista" required>
                                <option value="">Selecione o respons√°vel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data da Inspe√ß√£o:</label>
                            <input type="datetime-local" id="inspecaoData" required>
                        </div>
                        <div class="form-group">
                            <label>KM do Ve√≠culo:</label>
                            <input type="number" id="inspecaoKm" required min="0">
                        </div>
                    </div>
                </div>

                <!-- Checklist de Itens -->
                <div class="checklist-container" id="checklistContainer">
                    <div class="loading-checklist">
                        <p>Selecione o tipo de inspe√ß√£o para carregar o checklist...</p>
                    </div>
                </div>

                <!-- Observa√ß√µes Gerais -->
                <div class="form-group">
                    <label>Observa√ß√µes Gerais:</label>
                    <textarea id="inspecaoObservacoes" rows="3" placeholder="Observa√ß√µes sobre a inspe√ß√£o geral..."></textarea>
                </div>

                <!-- Resumo do Status -->
                <div class="inspecao-status-summary" id="statusSummary" style="display: none;">
                    <h4>Resumo da Inspe√ß√£o</h4>
                    <div class="status-stats">
                        <div class="status-stat status-ok">
                            <span class="stat-number" id="itensConformes">0</span>
                            <span class="stat-label">Conformes</span>
                        </div>
                        <div class="status-stat status-warning">
                            <span class="stat-number" id="itensAlerta">0</span>
                            <span class="stat-label">Com Alerta</span>
                        </div>
                        <div class="status-stat status-error">
                            <span class="stat-number" id="itensNaoConformes">0</span>
                            <span class="stat-label">N√£o Conformes</span>
                        </div>
                    </div>
                    <div class="status-result" id="statusResult">
                        <strong>Status Final:</strong> <span id="statusFinal"></span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inspecaoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Inspe√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o de Inspe√ß√£o -->
    <div id="visualizarInspecaoModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal('visualizarInspecaoModal')">&times;</span>
            <h3>Detalhes da Inspe√ß√£o</h3>

            <div id="inspecaoDetalhes">
                <!-- Ser√° preenchido dinamicamente -->
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('visualizarInspecaoModal')">Fechar</button>
                <button type="button" class="btn btn-danger" onclick="excluirInspecaoAtual()">Excluir Inspe√ß√£o</button>
            </div>
        </div>
    </div>

    <script src="js/api.js?v=2"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/gps-tracking.js?v=23"></script>
    <script src="js/inspections.js?v=20"></script>
    <script>
        // Inicializar sistema ap√≥s carregamento
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Aguardar carregamento do usu√°rio via API
                const user = await loadCurrentUser();

                if (!user) {
                    console.log('Usu√°rio n√£o autenticado');
                    window.location.href = 'index.html';
                    return;
                }

                console.log('Usu√°rio carregado:', user);

                // Atualizar mensagem de boas-vindas
                const welcomeEl = document.getElementById('welcomeMessage');
                if (welcomeEl) {
                    welcomeEl.textContent = `Bem-vindo, ${user.name || user.username}`;
                }

                // Inicializar sistema (j√° carrega todos os dados da API)
                await initSystem();

                // Inicializar √≠cones Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
                alert('Erro ao carregar dashboard. Redirecionando para login...');
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
