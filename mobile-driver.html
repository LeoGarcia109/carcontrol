<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarControl - Motorista</title>
    <link rel="stylesheet" href="css/mobile-driver.css?v=20251107-fix">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Background Gradient -->
    <div class="background-gradient"></div>

    <!-- Modern Glass Header -->
    <header class="mobile-header">
        <div class="header-content">
            <div class="user-info">
                <div class="user-avatar">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="8" r="3.5" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M4 20C4 17.7909 7.58172 16 12 16C16.4183 16 20 17.7909 20 20V21H4V20Z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="user-details">
                    <span class="user-greeting">Bem-vindo</span>
                    <span class="user-name" id="driverName">Motorista</span>
                </div>
            </div>

            <!-- A√ß√µes do Header: Offline + GPS + Logout agrupados √† direita -->
            <div class="header-actions">
                <!-- Offline Indicator -->
                <div id="offlineIndicator" class="offline-indicator online">
                    <svg width="16" height="16" fill="currentColor">
                        <circle cx="8" cy="8" r="6" fill="#10b981"/>
                    </svg>
                    <span>Online</span>
                    <div id="offlinePendingBadge" class="pending-badge" style="display: none;">0</div>
                </div>

                <!-- GPS Indicator -->
                <div id="gpsIndicator" class="gps-indicator inactive">
                    <svg width="16" height="16" fill="currentColor">
                        <circle cx="8" cy="8" r="3" fill="#94a3b8"/>
                        <path d="M8 0v3m0 10v3M0 8h3m10 0h3" stroke="#94a3b8" stroke-width="1"/>
                    </svg>
                    <span>GPS Inativo</span>
                </div>

                <button class="logout-btn" onclick="logout()" aria-label="Sair">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Modern Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card glass-card">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7V12C2 16.5 4.5 20.74 8 22C9.05 21.75 10.05 21.32 11 20.77C11.95 21.32 12.95 21.75 14 22C17.5 20.74 20 16.5 20 12V7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="statActiveTrips">0</div>
                    <div class="stat-label">Rotas Ativas</div>
                </div>
            </div>

            <div class="stat-card glass-card">
                <div class="stat-icon completed">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 12V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="statCompletedTrips">0</div>
                    <div class="stat-label">Conclu√≠das</div>
                </div>
            </div>

            <div class="stat-card glass-card">
                <div class="stat-icon pending">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="statPendingApproval">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
            </div>
        </div>

        <!-- Modern Filter Section -->
        <div class="filters-section">
            <h3 class="section-title">Minhas Rotas</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="todas" onclick="filterRoutes('todas')">
                    Todas
                </button>
                <button class="filter-btn" data-filter="em_uso" onclick="filterRoutes('em_uso')">
                    Ativas
                </button>
                <button class="filter-btn" data-filter="finalizado" onclick="filterRoutes('finalizado')">
                    Conclu√≠das
                </button>
                <button class="filter-btn" data-filter="pendente" onclick="filterRoutes('pendente')">
                    Pendentes
                </button>
            </div>
        </div>

        <!-- Routes List -->
        <div class="routes-container" id="routesContainer">
            <!-- Routes will be dynamically loaded here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 9L20 10M4 10L5 9L4 10ZM13 18H11H13ZM3 18L2.4 16.2C2.15769 15.4692 2 14.6 2 13.71V12.5C2 8.5 3 5.5 8 3L12 2L16 3C21 5.5 22 8.5 22 12.5V13.71C22 14.6 21.8423 15.4692 21.6 16.2L21 18L3 18Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>
                    <path d="M7 18L7 22M17 18V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
                </svg>
            </div>
            <h3>Nenhuma rota encontrada</h3>
            <p>Voc√™ ainda n√£o possui rotas cadastradas</p>
            <button class="btn-primary" onclick="openNewRouteModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Criar Primeira Rota
            </button>
        </div>
    </main>

    <!-- Speed Dial FAB (Floating Action Button) -->
    <div class="fab-container">
        <!-- Backdrop para fechar ao clicar fora -->
        <div class="fab-backdrop" id="fabBackdrop"></div>

        <!-- Bot√µes secund√°rios (aparecem ao expandir) -->
        <button class="fab-secondary" data-action="expense" aria-label="Nova Despesa">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 10C20 6 16 2 12 2C8 2 4 6 4 10C4 14 8 18 12 18M12 18C13.5 18 14.8 17.5 15.9 16.6M12 18V22M8 22H16M12 6V7M12 11V13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                <circle cx="12" cy="9.5" r="1.5" fill="currentColor"/>
            </svg>
            <span class="fab-tooltip">Despesa</span>
        </button>

        <button class="fab-secondary" data-action="inspection" aria-label="Nova Inspe√ß√£o">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <span class="fab-tooltip">Inspe√ß√£o</span>
        </button>

        <button class="fab-secondary" data-action="route" aria-label="Nova Rota">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C7.58172 2 4 5.58172 4 10C4 14.4183 12 22 12 22C12 22 20 14.4183 20 10C20 5.58172 16.4183 2 12 2Z" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <span class="fab-tooltip">Rota</span>
        </button>

        <!-- Bot√£o principal -->
        <button class="fab fab-main" id="fabMain" aria-label="Menu A√ß√µes">
            <svg class="fab-icon-default" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
            <svg class="fab-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
        </button>
    </div>

    <!-- Modal Nova Rota -->
    <div id="newRouteModal" class="modal">
        <div class="modal-overlay" onclick="closeNewRouteModal()"></div>
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h3>Nova Rota</h3>
                <button class="close-btn" onclick="closeNewRouteModal()" aria-label="Fechar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="newRouteForm">
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 9L20 10M4 10L5 9L4 10ZM13 18H11H13ZM3 18L2.4 16.2C2.15769 15.4692 2 14.6 2 13.71V12.5C2 8.5 3 5.5 8 3L12 2L16 3C21 5.5 22 8.5 22 12.5V13.71C22 14.6 21.8423 15.4692 21.6 16.2L21 18L3 18Z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Ve√≠culo
                    </label>
                    <select id="routeVehicle" required class="form-input">
                        <option value="">Selecione o ve√≠culo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C7.58172 2 4 5.58172 4 10C4 14.4183 12 22 12 22C12 22 20 14.4183 20 10C20 5.58172 16.4183 2 12 2Z" stroke="currentColor" stroke-width="1.5"/>
                            <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Destino
                    </label>
                    <select id="routeDestination" required class="form-input">
                        <option value="">Selecione o destino</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        KM Atual
                    </label>
                    <input type="number" id="routeKm" required min="0" placeholder="Digite a quilometragem atual" class="form-input">
                    <small class="form-helper">Informe a quilometragem atual do ve√≠culo</small>
                </div>

                <!-- Toggle Intercorr√™ncia / Observa√ß√µes -->
                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="routeHasIncident" style="width:18px; height:18px;">
                        Adicionar observa√ß√µes/intercorr√™ncia
                    </label>
                </div>

                <!-- Se√ß√£o Intercorr√™ncia / Observa√ß√µes (oculta por padr√£o) -->
                <div id="incidentSection" style="display:none; gap:12px;">
                    <div class="form-group">
                        <label>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 19.5V6.8C4 5.80589 4.80589 5 5.8 5H12.2C12.9712 5 13.6 5.62881 13.6 6.4V7.8H18.2C18.9712 7.8 19.6 8.42881 19.6 9.2V19.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M8 11H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M8 15H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Observa√ß√µes
                        </label>
                        <textarea id="routeNotes" class="form-input" rows="3" placeholder="Descreva a intercorr√™ncia ou observa√ß√µes"></textarea>
                    </div>

                    <div class="form-group">
                        <label>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M10 11L12 13L16 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Foto (opcional)
                        </label>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <input type="file" id="routeIncidentPhoto" accept="image/*" capture="environment">
                            <button type="button" id="btnRemoveIncidentPhoto" class="btn btn-secondary" style="display:none;" onclick="removeIncidentPhoto()">Remover</button>
                        </div>
                        <div id="incidentPhotoPreview" style="margin-top:8px; width:100%; max-width:320px; aspect-ratio:16/9; border:1px dashed #444; border-radius:8px; display:none; align-items:center; justify-content:center; overflow:hidden;"></div>
                    </div>
                </div>

                <div class="info-card">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="info-text">
                        <strong>Aten√ß√£o:</strong> A data e hora ser√£o registradas automaticamente no momento da abertura da rota.
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 12L3 21L12 18L21 21L19 12M5 12L12 2L19 12M5 12L12 18L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Iniciar Rota
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Finalizar Rota -->
    <div id="finalizeRouteModal" class="modal">
        <div class="modal-overlay" onclick="closeFinalizeRouteModal()"></div>
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h3>Finalizar Rota</h3>
                <button class="close-btn" onclick="closeFinalizeRouteModal()" aria-label="Fechar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="finalizeRouteForm">
                <input type="hidden" id="finalizeRouteId">

                <div class="route-summary" id="routeSummary">
                    <!-- Route details will be shown here -->
                </div>

                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        KM Final
                    </label>
                    <input type="number" id="routeKmFinal" required min="0" placeholder="Digite a quilometragem final" class="form-input">
                    <small class="form-helper">Informe a quilometragem no retorno</small>
                </div>

                <div class="info-card warning">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 9V13M12 17H12.01M4.93 4.93L19.07 19.07M12 2L2 12L12 22L22 12L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <div class="info-text">
                        <strong>Importante:</strong> Ap√≥s finalizar, a rota ficar√° pendente de aprova√ß√£o do administrador.
                    </div>
                </div>

                <button type="submit" class="btn-submit btn-danger">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Finalizar Rota
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Nova Despesa -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 10C20 6 16 2 12 2C8 2 4 6 4 10C4 14 8 18 12 18M12 18C13.5 18 14.8 17.5 15.9 16.6M12 18V22M8 22H16M12 6V7M12 11V13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="12" cy="9.5" r="1.5" fill="currentColor"/>
                    </svg>
                    Nova Despesa
                </h2>
                <button class="modal-close" onclick="closeExpenseModal()" aria-label="Fechar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="expenseForm" onsubmit="event.preventDefault(); submitExpense()">
                <!-- Ve√≠culo (auto-preenchido se houver rota ativa) -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M7 6V4M17 6V4M7 14H10M14 14H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Ve√≠culo
                    </label>
                    <select id="expenseVehicle" class="form-input" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                    <small class="form-helper">Ve√≠culo da rota ativa</small>
                </div>

                <!-- Categoria -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 2V6M15 2V6M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Categoria
                    </label>
                    <select id="expenseCategory" class="form-input" required onchange="toggleExpenseFields()">
                        <option value="">Selecione...</option>
                        <option value="abastecimento">Abastecimento</option>
                        <option value="pedagio">Ped√°gio</option>
                        <option value="estacionamento">Estacionamento</option>
                        <option value="lavagem">Lavagem</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>

                <!-- Data e Hora -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Data e Hora
                    </label>
                    <input type="datetime-local" id="expenseDate" class="form-input" required>
                </div>

                <!-- KM Atual -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        KM Atual
                    </label>
                    <input type="number" id="expenseKm" class="form-input" min="0" placeholder="0">
                    <small class="form-helper">Quilometragem no momento da despesa</small>
                </div>

                <!-- Campos espec√≠ficos para Abastecimento -->
                <div id="fuelFields" style="display: none;">
                    <div class="form-group">
                        <label>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 10C20 6 16 2 12 2C8 2 4 6 4 10C4 14 8 18 12 18M12 18C13.5 18 14.8 17.5 15.9 16.6M12 18V22M8 22H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Litros
                        </label>
                        <input type="number" id="expenseLiters" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V22M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Pre√ßo por Litro
                        </label>
                        <input type="text" id="expensePricePerLiter" class="form-input" placeholder="R$ 0,00">
                    </div>
                </div>

                <!-- Valor Total -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2V22M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Valor Total
                    </label>
                    <input type="text" id="expenseTotal" class="form-input" placeholder="R$ 0,00">
                    <small class="form-helper" id="expenseTotalHelper">Calculado automaticamente para abastecimento</small>
                </div>

                <!-- Observa√ß√µes -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Observa√ß√µes
                    </label>
                    <textarea id="expenseNotes" class="form-input" rows="3" placeholder="Informa√ß√µes adicionais (opcional)"></textarea>
                </div>

                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Salvar Despesa
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Nova Inspe√ß√£o -->
    <div id="inspectionModal" class="modal">
        <div class="modal-overlay" onclick="closeInspectionModal()"></div>
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h3>Nova Inspe√ß√£o</h3>
                <button class="modal-close" onclick="closeInspectionModal()" aria-label="Fechar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="inspectionForm" onsubmit="event.preventDefault(); submitInspection()">
                <!-- Tipo de Inspe√ß√£o -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 12V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Tipo de Inspe√ß√£o
                    </label>
                    <select id="inspectionType" class="form-input" required onchange="loadInspectionTemplate()">
                        <option value="">Selecione...</option>
                        <option value="pre_viagem">Pr√©-Viagem</option>
                        <option value="revisao">Revis√£o T√©cnica</option>
                    </select>
                </div>

                <!-- Ve√≠culo -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M7 6V4M17 6V4M7 14H10M14 14H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Ve√≠culo
                    </label>
                    <select id="inspectionVehicle" class="form-input" required disabled onchange="loadVehicleKm()">
                        <option value="">Carregando...</option>
                    </select>
                    <small class="form-helper">Ve√≠culo da rota ativa</small>
                </div>

                <!-- KM Atual -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        KM Atual
                    </label>
                    <input type="number" id="inspectionKm" class="form-input" min="0" placeholder="0" required>
                    <small class="form-helper">Quilometragem no momento da inspe√ß√£o</small>
                </div>

                <!-- Container do Checklist (ser√° preenchido dinamicamente) -->
                <div id="checklistContainer" class="checklist-container">
                    <div class="loading-checklist">
                        <p>Selecione o tipo de inspe√ß√£o para carregar o checklist...</p>
                    </div>
                </div>

                <!-- Resumo de Status -->
                <div id="inspectionStatusSummary" class="status-summary" style="display: none;">
                    <div class="summary-item">
                        <span class="summary-icon success">‚úì</span>
                        <span class="summary-label">Conformes:</span>
                        <span class="summary-value" id="itemsConformes">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-icon warning">‚ö†</span>
                        <span class="summary-label">Alertas:</span>
                        <span class="summary-value" id="itemsAlertas">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-icon danger">‚úó</span>
                        <span class="summary-label">N√£o Conformes:</span>
                        <span class="summary-value" id="itemsNaoConformes">0</span>
                    </div>
                </div>

                <!-- Observa√ß√µes Gerais -->
                <div class="form-group">
                    <label>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Observa√ß√µes Gerais
                    </label>
                    <textarea id="inspectionObservations" class="form-input" rows="3" placeholder="Informa√ß√µes adicionais (opcional)"></textarea>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" id="inspectionTemplateId" value="">
                <input type="hidden" id="inspectionDriverId" value="">

                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Salvar Inspe√ß√£o
                </button>
            </form>
        </div>
    </div>

    <!-- Offline Support Scripts -->
    <script src="js/offline-db.js?v=20251116-fix2"></script>
    <script src="js/sync-manager.js?v=20251116-fix2"></script>

    <!-- Core Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/mobile-driver.js?v=20251116-fix2"></script>

    <!-- Service Worker Registration -->
    <script>
        // Registrar Service Worker para suporte offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    console.log('[SW] üîÑ Iniciando processo de atualiza√ß√£o for√ßada do Service Worker...');

                    // PASSO 1: Desregistrar TODOS os Service Workers antigos
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    console.log(`[SW] üóëÔ∏è Encontrados ${registrations.length} Service Workers para desregistrar`);

                    for (let registration of registrations) {
                        const unregistered = await registration.unregister();
                        console.log('[SW] ‚úÖ Service Worker desregistrado:', unregistered);
                    }

                    // PASSO 2: Limpar TODOS os caches
                    const cacheNames = await caches.keys();
                    console.log(`[SW] üóëÔ∏è Encontrados ${cacheNames.length} caches para deletar:`, cacheNames);

                    for (let cacheName of cacheNames) {
                        const deleted = await caches.delete(cacheName);
                        console.log(`[SW] ‚úÖ Cache deletado: ${cacheName} (${deleted})`);
                    }

                    console.log('[SW] ‚úÖ Limpeza completa! Registrando novo Service Worker...');

                    // PASSO 3: Registrar novo Service Worker
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        updateViaCache: 'none' // N√£o usar cache para o pr√≥prio sw.js
                    });
                    console.log('[SW] ‚úÖ Service Worker v1.0.2 registered:', registration.scope);

                    // PASSO 4: For√ßar atualiza√ß√£o imediata
                    await registration.update();
                    console.log('[SW] ‚úÖ Update for√ßado executado');

                    // Listen para atualiza√ß√µes do SW
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('[SW] üÜï New service worker found');

                        newWorker.addEventListener('statechange', () => {
                            console.log('[SW] üìä SW State:', newWorker.state);

                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // Nova vers√£o dispon√≠vel - for√ßar reload
                                    console.log('[SW] üîÑ Nova vers√£o instalada! Recarregando p√°gina...');
                                    window.location.reload();
                                } else {
                                    // Primeira instala√ß√£o
                                    console.log('[SW] ‚úÖ Service Worker instalado pela primeira vez');
                                }
                            }

                            if (newWorker.state === 'activated') {
                                console.log('[SW] ‚úÖ Service Worker ativado!');
                            }
                        });
                    });

                    // Se j√° existe um SW ativo, for√ßar skip waiting
                    if (navigator.serviceWorker.controller) {
                        console.log('[SW] ‚è≠Ô∏è Enviando skipWaiting para SW ativo');
                        navigator.serviceWorker.controller.postMessage({ action: 'skipWaiting' });
                    }

                } catch (error) {
                    console.error('[SW] ‚ùå Service Worker registration failed:', error);
                }
            });
        } else {
            console.warn('[SW] ‚ö†Ô∏è Service Workers not supported');
        }
    </script>
</body>
</html>
