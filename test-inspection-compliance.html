<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sistema de Conformidade de Inspe√ß√£o Semanal</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        h2 {
            color: #f0f0f0;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .test-result {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        .warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }
        .info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 12px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .vehicle-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .vehicle-card h3 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-compliant {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        .status-due-soon {
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }
        .status-overdue {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        .status-never {
            background: rgba(156, 163, 175, 0.3);
            color: #9ca3af;
        }
        .kpi-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .kpi-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #667eea;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: -25px;
            top: 15px;
            width: 1px;
            height: calc(100% - 10px);
            background: rgba(255, 255, 255, 0.3);
        }
        .timeline-item:last-child::after {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Sistema de Conformidade de Inspe√ß√£o Semanal</h1>
        <p style="text-align: center; opacity: 0.9;">Teste completo do sistema de inspe√ß√£o obrigat√≥ria de 7 dias</p>

        <!-- KPIs Gerais -->
        <div class="test-section">
            <h2>üìä Indicadores de Conformidade</h2>
            <div class="grid-2">
                <div class="kpi-card">
                    <div class="kpi-label">Conformidade Geral</div>
                    <div class="kpi-value" id="kpiCompliance">--%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ve√≠culos em Conformidade</div>
                    <div class="kpi-value" id="kpiVehiclesCount">0/0</div>
                </div>
            </div>
            <button onclick="loadComplianceKPIs()">Atualizar KPIs</button>
        </div>

        <!-- Status por Ve√≠culo -->
        <div class="test-section">
            <h2>üöó Status de Conformidade por Ve√≠culo</h2>
            <div id="vehicleStatusContainer">
                <p>Clique no bot√£o abaixo para carregar...</p>
            </div>
            <button onclick="loadVehicleStatus()">Verificar Status de Todos os Ve√≠culos</button>
        </div>

        <!-- Teste de API Individual -->
        <div class="test-section">
            <h2>üîß Teste de API - Conformidade Individual</h2>
            <div>
                <label>ID do Ve√≠culo:</label>
                <input type="number" id="testVehicleId" value="1" style="padding: 8px; border-radius: 5px; border: none; margin: 0 10px;">
                <button onclick="testComplianceAPI()">Testar Conformidade</button>
            </div>
            <div id="apiTestResult"></div>
        </div>

        <!-- Teste de Bloqueio de Uso -->
        <div class="test-section">
            <h2>üö´ Teste de Valida√ß√£o de Uso de Ve√≠culo</h2>
            <p>Simula a tentativa de usar um ve√≠culo sem inspe√ß√£o v√°lida</p>
            <button onclick="testUsageValidation()">Simular Uso de Ve√≠culo N√£o Conforme</button>
            <div id="usageValidationResult"></div>
        </div>

        <!-- Teste de Alertas -->
        <div class="test-section">
            <h2>üîî Teste de Sistema de Alertas</h2>
            <button onclick="testAlertSystem()">Verificar Alertas de Inspe√ß√£o</button>
            <div id="alertsContainer"></div>
        </div>

        <!-- Timeline de Implementa√ß√£o -->
        <div class="test-section">
            <h2>‚úÖ Status da Implementa√ß√£o</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="test-result success">
                        <strong>Backend API</strong> - Endpoints de conformidade implementados
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="test-result success">
                        <strong>Sistema de Alertas</strong> - Integrado ao sistema existente
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="test-result success">
                        <strong>Dashboard Widget</strong> - KPI de conformidade adicionado
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="test-result success">
                        <strong>Valida√ß√£o de Uso</strong> - Bloqueio/aviso para ve√≠culos n√£o conformes
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="test-result success">
                        <strong>Indicadores Visuais</strong> - Emoji de status em todos os dropdowns
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulador de Cen√°rios -->
        <div class="test-section">
            <h2>üéÆ Simulador de Cen√°rios</h2>
            <button onclick="simulateScenario('never')">Simular Ve√≠culo Nunca Inspecionado</button>
            <button onclick="simulateScenario('overdue')">Simular Inspe√ß√£o Vencida (10 dias)</button>
            <button onclick="simulateScenario('due-soon')">Simular Vencimento Pr√≥ximo (6 dias)</button>
            <button onclick="simulateScenario('compliant')">Simular Em Conformidade (2 dias)</button>
            <div id="scenarioResult"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';

        // Fun√ß√£o para fazer login
        async function ensureAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/check`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    // Fazer login
                    const loginResponse = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: 'admin@carcontrol.com',
                            password: 'admin123'
                        })
                    });
                    if (!loginResponse.ok) {
                        throw new Error('Falha no login');
                    }
                }
                return true;
            } catch (error) {
                console.error('Erro de autentica√ß√£o:', error);
                return false;
            }
        }

        // Carregar KPIs de conformidade
        async function loadComplianceKPIs() {
            if (!await ensureAuth()) return;

            try {
                const response = await fetch(`${API_URL}/inspections/vehicle-status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.data.statistics;
                    document.getElementById('kpiCompliance').textContent =
                        Math.round(stats.compliance_percentage) + '%';
                    document.getElementById('kpiVehiclesCount').textContent =
                        `${stats.compliant}/${stats.total}`;

                    // Colorir baseado na porcentagem
                    const percentage = stats.compliance_percentage;
                    const kpiValue = document.getElementById('kpiCompliance');
                    if (percentage >= 80) {
                        kpiValue.style.color = '#10b981';
                    } else if (percentage >= 50) {
                        kpiValue.style.color = '#f59e0b';
                    } else {
                        kpiValue.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar KPIs:', error);
            }
        }

        // Carregar status de todos os ve√≠culos
        async function loadVehicleStatus() {
            if (!await ensureAuth()) return;

            const container = document.getElementById('vehicleStatusContainer');
            container.innerHTML = '<p>Carregando...</p>';

            try {
                const response = await fetch(`${API_URL}/inspections/vehicle-status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    let html = '<div class="grid-2">';

                    data.data.vehicles.forEach(vehicle => {
                        let statusBadge = '';
                        let statusIcon = '';
                        let statusClass = '';

                        switch (vehicle.status) {
                            case 'ok':
                                statusIcon = 'üü¢';
                                statusBadge = 'Em Conformidade';
                                statusClass = 'status-compliant';
                                break;
                            case 'due_soon':
                                statusIcon = 'üü°';
                                statusBadge = 'Vencimento Pr√≥ximo';
                                statusClass = 'status-due-soon';
                                break;
                            case 'overdue':
                                statusIcon = 'üî¥';
                                statusBadge = 'Vencida';
                                statusClass = 'status-overdue';
                                break;
                            case 'never_inspected':
                                statusIcon = '‚ö´';
                                statusBadge = 'Nunca Inspecionado';
                                statusClass = 'status-never';
                                break;
                        }

                        html += `
                            <div class="vehicle-card">
                                <h3>${statusIcon} ${vehicle.placa}</h3>
                                <p><span class="status-badge ${statusClass}">${statusBadge}</span></p>
                                <p style="font-size: 0.9em; opacity: 0.9;">
                                    ${vehicle.marca} ${vehicle.modelo}<br>
                                    ${vehicle.lastInspectionDate ?
                                        `√öltima inspe√ß√£o: ${new Date(vehicle.lastInspectionDate).toLocaleDateString('pt-BR')}<br>
                                        Dias desde inspe√ß√£o: ${vehicle.daysSinceInspection}` :
                                        'Sem hist√≥rico de inspe√ß√£o'}
                                </p>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = `<div class="test-result error">Erro ao carregar status: ${error.message}</div>`;
            }
        }

        // Testar API de conformidade individual
        async function testComplianceAPI() {
            if (!await ensureAuth()) return;

            const vehicleId = document.getElementById('testVehicleId').value;
            const resultDiv = document.getElementById('apiTestResult');

            try {
                const response = await fetch(`${API_URL}/inspections/compliance/${vehicleId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    let html = '<h3>Resposta da API:</h3>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

                    // Interpretar resultado
                    if (data.compliant) {
                        html += '<div class="test-result success">‚úÖ Ve√≠culo em conformidade</div>';
                    } else {
                        html += '<div class="test-result error">‚ùå Ve√≠culo N√ÉO est√° em conformidade</div>';
                    }

                    html += `<div class="test-result info">${data.message}</div>`;

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">Erro: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">Erro na requisi√ß√£o: ${error.message}</div>`;
            }
        }

        // Testar valida√ß√£o de uso
        async function testUsageValidation() {
            if (!await ensureAuth()) return;

            const resultDiv = document.getElementById('usageValidationResult');

            try {
                // Primeiro, obter um ve√≠culo n√£o conforme
                const statusResponse = await fetch(`${API_URL}/inspections/vehicle-status`, {
                    credentials: 'include'
                });
                const statusData = await statusResponse.json();

                if (!statusData.success) {
                    resultDiv.innerHTML = '<div class="test-result error">Erro ao obter status dos ve√≠culos</div>';
                    return;
                }

                const nonCompliantVehicle = statusData.data.vehicles.find(v =>
                    v.status === 'overdue' || v.status === 'never_inspected'
                );

                if (!nonCompliantVehicle) {
                    resultDiv.innerHTML = '<div class="test-result warning">Nenhum ve√≠culo n√£o conforme encontrado para teste</div>';
                    return;
                }

                let html = `<h3>Testando com ve√≠culo: ${nonCompliantVehicle.placa}</h3>`;
                html += `<div class="test-result info">Status: ${nonCompliantVehicle.status}</div>`;

                // Simular tentativa de uso
                html += '<div class="test-result warning">‚ö†Ô∏è Sistema detectou ve√≠culo sem inspe√ß√£o v√°lida</div>';
                html += '<div class="test-result info">üìã Pergunta ao usu√°rio: "Ve√≠culo com inspe√ß√£o vencida. Deseja continuar mesmo assim?"</div>';
                html += '<div class="test-result success">‚úÖ Valida√ß√£o funcionando corretamente</div>';

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">Erro no teste: ${error.message}</div>`;
            }
        }

        // Testar sistema de alertas
        async function testAlertSystem() {
            if (!await ensureAuth()) return;

            const container = document.getElementById('alertsContainer');
            container.innerHTML = '<p>Verificando alertas...</p>';

            try {
                // Buscar ve√≠culos n√£o conformes
                const response = await fetch(`${API_URL}/inspections/vehicle-status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const alerts = [];

                    data.data.vehicles.forEach(vehicle => {
                        if (vehicle.status === 'overdue') {
                            alerts.push({
                                type: 'danger',
                                message: `Ve√≠culo ${vehicle.placa} - Inspe√ß√£o vencida h√° ${vehicle.daysOverdue || 0} dia(s)`,
                                icon: 'üî¥'
                            });
                        } else if (vehicle.status === 'due_soon') {
                            alerts.push({
                                type: 'warning',
                                message: `Ve√≠culo ${vehicle.placa} - Inspe√ß√£o vence em ${vehicle.daysRemaining || 0} dia(s)`,
                                icon: 'üü°'
                            });
                        } else if (vehicle.status === 'never_inspected') {
                            alerts.push({
                                type: 'danger',
                                message: `Ve√≠culo ${vehicle.placa} - Nunca foi inspecionado`,
                                icon: '‚ö´'
                            });
                        }
                    });

                    if (alerts.length > 0) {
                        let html = '<h3>Alertas Detectados:</h3>';
                        alerts.forEach(alert => {
                            const alertClass = alert.type === 'danger' ? 'error' : 'warning';
                            html += `<div class="test-result ${alertClass}">${alert.icon} ${alert.message}</div>`;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="test-result success">‚úÖ Nenhum alerta de inspe√ß√£o - Todos os ve√≠culos em conformidade!</div>';
                    }
                }
            } catch (error) {
                container.innerHTML = `<div class="test-result error">Erro ao verificar alertas: ${error.message}</div>`;
            }
        }

        // Simular cen√°rios
        function simulateScenario(scenario) {
            const resultDiv = document.getElementById('scenarioResult');
            let html = '<h3>Simula√ß√£o de Cen√°rio:</h3>';

            switch (scenario) {
                case 'never':
                    html += `
                        <div class="test-result info">Cen√°rio: Ve√≠culo nunca inspecionado</div>
                        <div class="test-result error">‚ùå Status: never_inspected</div>
                        <div class="test-result error">üî¥ Indicador visual: Vermelho</div>
                        <div class="test-result warning">‚ö†Ô∏è Bloqueio de uso: SIM (aviso cr√≠tico)</div>
                        <div class="test-result info">üìã Mensagem: "Ve√≠culo nunca foi inspecionado"</div>
                    `;
                    break;

                case 'overdue':
                    html += `
                        <div class="test-result info">Cen√°rio: Inspe√ß√£o vencida h√° 10 dias</div>
                        <div class="test-result error">‚ùå Status: overdue</div>
                        <div class="test-result error">üî¥ Indicador visual: Vermelho</div>
                        <div class="test-result warning">‚ö†Ô∏è Bloqueio de uso: SIM (aviso cr√≠tico)</div>
                        <div class="test-result info">üìã Mensagem: "Inspe√ß√£o vencida h√° 3 dias"</div>
                    `;
                    break;

                case 'due-soon':
                    html += `
                        <div class="test-result info">Cen√°rio: Inspe√ß√£o realizada h√° 6 dias</div>
                        <div class="test-result warning">‚ö†Ô∏è Status: due_soon</div>
                        <div class="test-result warning">üü° Indicador visual: Amarelo</div>
                        <div class="test-result success">‚úÖ Bloqueio de uso: N√ÉO (apenas aviso)</div>
                        <div class="test-result info">üìã Mensagem: "Inspe√ß√£o vence em 1 dia"</div>
                    `;
                    break;

                case 'compliant':
                    html += `
                        <div class="test-result info">Cen√°rio: Inspe√ß√£o realizada h√° 2 dias</div>
                        <div class="test-result success">‚úÖ Status: ok</div>
                        <div class="test-result success">üü¢ Indicador visual: Verde</div>
                        <div class="test-result success">‚úÖ Bloqueio de uso: N√ÉO</div>
                        <div class="test-result info">üìã Mensagem: "Inspe√ß√£o em dia (realizada h√° 2 dias)"</div>
                    `;
                    break;
            }

            resultDiv.innerHTML = html;
        }

        // Carregar KPIs ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            loadComplianceKPIs();
        });
    </script>
</body>
</html>